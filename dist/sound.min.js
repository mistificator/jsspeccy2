SoundGenerator=function(e){var r={},n=(e=e||{}).debugPrint||!1,a=e.model.clockSpeed,o=e.model.frameLength,t=e.backendSampleRate||44100,f=e.backendEnabled||!1,s=e.backendAudioBufferSize||1024,i=Math.floor(t*o/a),c=0,u=new Array,l=0,d=0,m=0,h=0,v=0,M=new Array,p=0,b=0,k=0,g=0,w=(new Int32Array(16),0),_=new Int32Array(16),y=0,S=0,A=0,R=0,x=0,z=0,B=0,G=0,I=0,E=0,F=0,P=0,q=0,L=0,Y=0,j=0,C=0,D=0,H=0,J=0,K=0,N=0,O=0,Q=0,T=0,U=0,V=0,W=new Int32Array(64),X=0;function Z(e,r){var n;switch(_[e]=r,e){case 0:case 1:_[1]=15&_[1],n=S,0==(S=Math.round((_[0]+256*_[1])*y))&&(S=Math.round(y)),(B+=S-n)<=0&&(B=1);break;case 2:case 3:_[3]=15&_[3],n=A,0==(A=Math.round((_[2]+256*_[3])*y))&&(A=Math.round(y)),(G=G+A-n)<=0&&(G=1);break;case 4:case 5:_[5]=15&_[5],n=R,0==(R=Math.round((_[4]+256*_[5])*y))&&(R=Math.round(y)),(I+=R-n)<=0&&(I=1);break;case 6:_[6]=31&_[6],n=x,0==(x=Math.round(_[6]*y))&&(x=Math.round(y)),(E+=x-n)<=0&&(E=1);break;case 8:_[8]=31&_[8],j=16&_[8],P=0!=j?Y:0!=_[8]?W[2*_[8]+1]:W[0];break;case 9:_[9]=31&_[9],C=16&_[9],q=0!=C?Y:0!=_[9]?W[2*_[9]+1]:W[0];break;case 10:_[10]=31&_[10],D=16&_[10],L=0!=D?Y:0!=_[10]?W[2*_[10]+1]:W[0];break;case 11:case 12:n=z,0==(z=Math.round((_[11]+256*_[12])*y))&&(z=Math.round(y/2)),(F+=z-n)<=0&&(F=1);break;case 13:255!=_[13]&&(_[13]=15&_[13],U=4==(4&_[13])?31:0,Q=1&_[13],T=2&_[13],F=z,V=0,Y=W[(O=31)^U],0!=j&&(P=Y),0!=C&&(q=Y),0!=D&&(L=Y))}}function $(e,r,n){return w=r,function(e){y=32768*w*8/e}(e),function(e,r){var n;for(r&=255,63,n=63;r>0;)r--,1.023292992,n*=1.023292992;for(var a=31;a>=0;a--)W[a]=n>63?63:Math.round(n),1.188502227,n/=1.188502227;W[63]=63}(0,12),function(){0,H=0,J=0,K=0,N=255,S=0,A=0,R=0,x=0,z=0,B=0,G=0,I=0,E=0,F=0,P=0,q=0,L=0,Y=0,j=0,C=0,D=0,O=0,Q=0,T=0,V=0,U=0;for(var e=0;e<=14;e++)Z(e,0)}(),0}$(a/2,t,8);for(var ee=0,re=new Array(1024),ne=0;ne<1024;ne++)re[ne]=Math.round(510*Math.random());function ae(){var e,r,n,a,o;e=0,r=0,n=0,a=32768;do{if(o=0,o=E<a?E:a,8==(8&X)){for(1==H&&(e+=B),B-=o;B<=0;){if((B+=S)>0){0==(1&_[7])&&(H^=1),0!=H&&(e+=S);break}B+=S,e+=S}1==H&&(e-=B)}else for(B-=o;B<=0;){if((B+=S)>0){H^=1;break}B+=S}if(16==(16&X)){for(1==J&&(r+=G),G-=o;G<=0;){if((G+=A)>0){0==(2&_[7])&&(J^=1),0!=J&&(r+=A);break}G+=A,r+=A}1==J&&(r-=G)}else for(G-=o;G<=0;){if((G+=A)>0){J^=1;break}G+=A}if(32==(32&X)){for(1==K&&(n+=I),I-=o;I<=0;){if((I+=R)>0){0==(4&_[7])&&(K^=1),0!=K&&(n+=R);break}I+=R,n+=R}1==K&&(n-=I)}else for(I-=o;I<=0;){if((I+=R)>0){K^=1;break}I+=R}(E-=o)<=0&&(N=re[ee=(ee+1)%1024],X=N|_[7],E+=x),a-=o}while(a>0);if(0==V&&(F-=32768)<=0){do{O-=1,F+=z}while(F<=0);O<0&&(0!=Q?(0!=T&&(U^=31),V=1,O=0):(0!=T&32==(32&O)&&(U^=31),O&=31)),Y=W[O^U],0!=j&&(P=Y),0!=C&&(q=Y),0!=D&&(L=Y)}return(e*P/65535+r*q/65535+n*L/65535)/63}var oe=performance.now(),te=0,fe=0;function se(e){if(f){e=Math.floor(e);var r=p;M.length<p+e&&(M.length+=Math.max(65536,e)),p+=e;for(var n=r;n<p;n++,b++,v++)25==v&&(1==(1&_[7])?(B<=13107200&&(B+=13107200),H=1):0==_[8]&&B<=13107200&&(B+=13107200),2==(2&_[7])?(G<=13107200&&(G+=13107200),J=1):0==_[9]&&G<=13107200&&(G+=13107200),4==(4&_[7])?(I<=13107200&&(I+=13107200),K=1):0==_[10]&&I<=13107200&&(I+=13107200),56==(56&_[7])&&E<=13107200&&(E+=13107200),X=N|_[7],v=0),M[n]=ae()}}r.fillBuffer=function(){for(var e=new Array(s),r=0,a=0;a<s;a++){for(var o=0,t=0;t<8&&r<l;t++,r++)o+=u[r];o/=t||1,o*=.7,o+=M[a]/2,e[a]=o}if((r=8*s)>=l)te+=r-l,l=0;else{l-=r;for(a=0;a<l;a++)u[a]=u[a+r]}if(s>=p)p=0;else{p-=s;for(a=0;a<p;a++)M[a]=M[a+s]}if(n){var f=performance.now();f-oe>5e3&&(console.log("Sound data tail "+(l+p)+", skipped "+te+", correction "+fe),oe=f,te=0,fe=0)}return e},r.updateBuzzer=function(e,r){0==e&&(e=-1),ie((r-m)*t*8/a,c),c=e,m=r};var ie=function(e,r){if(f&&(e=Math.floor(e))>0){var n=l+e;u.length<n&&(u.length+=Math.max(65536,e)),u.fill(r,l,n),l=n,d+=e}};return r.endFrame=function(){var e=0;m&&(e=c);var r=0;const n=128*Math.sqrt(s)*8;l<n&&(r=n-l)&&(fe+=r,r=Math.min(r,s),r=8*Math.floor(r/8)),ie(8*i-d+r,e),r=0,8*p<n&&(r=n-8*p)&&(fe+=r,r=Math.min(r,s),r=8*Math.floor(r/8)),se(i-b+r/8),m=0,g=0,d=0,b=0,h++<2||f&&postMessage(["notifyReady",l/8])},r.selectSoundRegister=function(e){k=e},r.writeSoundRegister=function(e,r){se((r-g)*t/a),g=r,Z(k,e)},r.readSoundRegister=function(){return _[k]},r.reset=function(){X=0,$(a/2,t)},r.setEnabled=function(e){f=e},r},onmessage=function(e){if(self.opts&&self.opts.debugPrint){var r=performance.now();self.commands_count=(self.commands_count||0)+e.data.length,self.prev_time=self.prev_time||r,r-self.prev_time>5e3&&(console.log("Sound worker received ",self.commands_count," AY8912 commands, ",(1e3*self.commands_count/(r-self.prev_time)).toFixed(2)," commands per sec"),self.prev_time=r,self.commands_count=0)}for(var n of e.data){if("SoundGenerator"===n[0])self.snd_gen=SoundGenerator.apply(null,n[1]),self.opts=n[1][0];else{var a=function(e){return self.snd_gen[e[0]].apply(null,e[1])}(n);a&&postMessage([n[0],a])}}};

SoundGenerator=function(e){var n={},a=(e=e||{}).debugPrint||!1,r=e.model.clockSpeed,t=e.model.frameLength,o=e.backendSampleRate||44100,f=e.backendEnabled||!1,u=Math.floor(o*t/r),i=0,l=new Array,c=0,d=0,s=0,h=0,g=new Array,M=0,b=0,v=0,k=(new Int32Array(16),0),p=new Int32Array(16),w=0,y=0,S=0,m=0,A=0,R=0,D=0,G=0,I=0,z=0,B=0,E=0,_=0,F=0,L=0,P=0,j=0,q=0,x=0,C=0,H=0,J=0,K=0,N=0,O=0,Q=0,T=0,U=new Int32Array(64),V=0;function W(e,n){var a;switch(p[e]=n,e){case 0:case 1:p[1]=15&p[1],a=y,0==(y=Math.round((p[0]+256*p[1])*w))&&(y=Math.round(w)),(D+=y-a)<=0&&(D=1);break;case 2:case 3:p[3]=15&p[3],a=S,0==(S=Math.round((p[2]+256*p[3])*w))&&(S=Math.round(w)),(G=G+S-a)<=0&&(G=1);break;case 4:case 5:p[5]=15&p[5],a=m,0==(m=Math.round((p[4]+256*p[5])*w))&&(m=Math.round(w)),(I+=m-a)<=0&&(I=1);break;case 6:p[6]=31&p[6],a=A,0==(A=Math.round(p[6]*w))&&(A=Math.round(w)),(z+=A-a)<=0&&(z=1);break;case 8:p[8]=31&p[8],P=16&p[8],E=0!=P?L:0!=p[8]?U[2*p[8]+1]:U[0];break;case 9:p[9]=31&p[9],j=16&p[9],_=0!=j?L:0!=p[9]?U[2*p[9]+1]:U[0];break;case 10:p[10]=31&p[10],q=16&p[10],F=0!=q?L:0!=p[10]?U[2*p[10]+1]:U[0];break;case 11:case 12:a=R,0==(R=Math.round((p[11]+256*p[12])*w))&&(R=Math.round(w/2)),(B+=R-a)<=0&&(B=1);break;case 13:255!=p[13]&&(p[13]=15&p[13],Q=4==(4&p[13])?31:0,N=1&p[13],O=2&p[13],B=R,T=0,L=U[(K=31)^Q],0!=P&&(E=L),0!=j&&(_=L),0!=q&&(F=L))}}function X(e,n,a){return k=n,function(e){w=32768*k*8/e}(e),function(e,n){var a;for(n&=255,63,a=63;n>0;)n--,1.023292992,a*=1.023292992;for(var r=31;r>=0;r--)U[r]=a>63?63:Math.round(a),1.188502227,a/=1.188502227;U[63]=63}(0,12),function(){0,x=0,C=0,H=0,J=255,y=0,S=0,m=0,A=0,R=0,D=0,G=0,I=0,z=0,B=0,E=0,_=0,F=0,L=0,P=0,j=0,q=0,K=0,N=0,O=0,T=0,Q=0;for(var e=0;e<=14;e++)W(e,0)}(),0}function Y(){var e,n,a,r,t;e=0,n=0,a=0,r=32768;do{if(t=0,t=z<r?z:r,8==(8&V)){for(1==x&&(e+=D),D-=t;D<=0;){if((D+=y)>0){0==(1&p[7])&&(x^=1),0!=x&&(e+=y);break}D+=y,e+=y}1==x&&(e-=D)}else for(D-=t;D<=0;){if((D+=y)>0){x^=1;break}D+=y}if(16==(16&V)){for(1==C&&(n+=G),G-=t;G<=0;){if((G+=S)>0){0==(2&p[7])&&(C^=1),0!=C&&(n+=S);break}G+=S,n+=S}1==C&&(n-=G)}else for(G-=t;G<=0;){if((G+=S)>0){C^=1;break}G+=S}if(32==(32&V)){for(1==H&&(a+=I),I-=t;I<=0;){if((I+=m)>0){0==(4&p[7])&&(H^=1),0!=H&&(a+=m);break}I+=m,a+=m}1==H&&(a-=I)}else for(I-=t;I<=0;){if((I+=m)>0){H^=1;break}I+=m}(z-=t)<=0&&(J=Math.round(510*Math.random()),V=J|p[7],z+=A),r-=t}while(r>0);if(0==T&&(B-=32768)<=0){do{K-=1,B+=R}while(B<=0);K<0&&(0!=N?(0!=O&&(Q^=31),T=1,K=0):(0!=O&32==(32&K)&&(Q^=31),K&=31)),L=U[K^Q],0!=P&&(E=L),0!=j&&(_=L),0!=q&&(F=L)}return(e*E/65535+n*_/65535+a*F/65535)/63}X(r/2,o,8);var Z=performance.now(),$=0,ee=0;function ne(e){if(f){e=Math.floor(e);var n=g.length;g.length+=e;for(var a=n;a<g.length;a++,M++,h++)25==h&&(1==(1&p[7])?(D<=13107200&&(D+=13107200),x=1):0==p[8]&&D<=13107200&&(D+=13107200),2==(2&p[7])?(G<=13107200&&(G+=13107200),C=1):0==p[9]&&G<=13107200&&(G+=13107200),4==(4&p[7])?(I<=13107200&&(I+=13107200),H=1):0==p[10]&&I<=13107200&&(I+=13107200),56==(56&p[7])&&z<=13107200&&(z+=13107200),V=J|p[7],h=0),g[a]=Y()}}return n.fillBuffer=function(e){for(var n=new Array(e),r=0,t=0;t<n.length;t++){for(var o=0,f=0;f<8&&r<l.length;f++,r++)o+=l[r];o/=f||1,o*=.7,o+=g[t]/2,n[t]=o}if((r=8*n.length)>=l.length?($+=r-l.length,l=new Array):l.splice(0,r),n.length>=g.length?g=new Array:g.splice(0,n.length),a){var u=performance.now();u-Z>5e3&&(console.log("Sound data tail "+l.length+", skipped "+$+", correction "+ee),Z=u,$=0,ee=0)}return n},n.updateBuzzer=function(e,a){if(0==e&&(e=-1),i!=e){var t=(a-d)*o*8/r;n.createSoundData(t,i),i=e,d=a}},n.createSoundData=function(e,n){if(f&&(e=Math.floor(e))>0){var a=l.length;l.length+=e,l.fill(n,a),c+=e}},n.endFrame=function(){var e=0;d&&(e=i);var a=0;const r=.1*o*8;l.length<r&&(a=r-l.length,ee+=a,a&&(a=Math.min(a,1024)));a=8*Math.floor(a/8),n.createSoundData(8*u-c+a,e),ne(u-M+a/8),d=0,v=0,c=0,M=0,s++<2||f&&postMessage(["notifyReady",l.length/8])},n.selectSoundRegister=function(e){b=e},n.writeSoundRegister=function(e,n){ne((n-v)*o/r),v=n,W(b,e)},n.readSoundRegister=function(){return p[b]},n.reset=function(){V=0,X(r/2,o)},n.setEnabled=function(e){f=e},n},onmessage=function(e){if("SoundGenerator"===e.data[0]){var n=e.data[1];self.snd_gen=SoundGenerator.apply(null,n)}else{var a=function(e){var n=e.data[1];return self.snd_gen[e.data[0]].apply(null,n)}(e);a&&postMessage([e.data[0],a])}};

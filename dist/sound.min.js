SoundGenerator=function(e){var r={},n=(e=e||{}).debugPrint||!1,a=e.model.clockSpeed,o=e.model.frameLength,t=e.backendSampleRate||44100,f=e.backendEnabled||!1,s=e.backendAudioBufferSize||1024,c=Math.floor(t*o/a),i=0,u=new Array,d=0,l=0,m=0,h=0,v=0,M=new Array,p=0,b=0,k=0,g=0,w=(new Int32Array(16),0),S=new Int32Array(16),_=0,y=0,A=0,R=0,x=0,z=0,B=0,D=0,G=0,I=0,E=0,F=0,P=0,L=0,Y=0,j=0,q=0,C=0,H=0,J=0,K=0,N=0,O=0,Q=0,T=0,U=0,V=0,W=new Int32Array(64),X=0;function Z(e,r){var n;switch(S[e]=r,e){case 0:case 1:S[1]=15&S[1],n=y,0==(y=Math.round((S[0]+256*S[1])*_))&&(y=Math.round(_)),(B+=y-n)<=0&&(B=1);break;case 2:case 3:S[3]=15&S[3],n=A,0==(A=Math.round((S[2]+256*S[3])*_))&&(A=Math.round(_)),(D=D+A-n)<=0&&(D=1);break;case 4:case 5:S[5]=15&S[5],n=R,0==(R=Math.round((S[4]+256*S[5])*_))&&(R=Math.round(_)),(G+=R-n)<=0&&(G=1);break;case 6:S[6]=31&S[6],n=x,0==(x=Math.round(S[6]*_))&&(x=Math.round(_)),(I+=x-n)<=0&&(I=1);break;case 8:S[8]=31&S[8],j=16&S[8],F=0!=j?Y:0!=S[8]?W[2*S[8]+1]:W[0];break;case 9:S[9]=31&S[9],q=16&S[9],P=0!=q?Y:0!=S[9]?W[2*S[9]+1]:W[0];break;case 10:S[10]=31&S[10],C=16&S[10],L=0!=C?Y:0!=S[10]?W[2*S[10]+1]:W[0];break;case 11:case 12:n=z,0==(z=Math.round((S[11]+256*S[12])*_))&&(z=Math.round(_/2)),(E+=z-n)<=0&&(E=1);break;case 13:255!=S[13]&&(S[13]=15&S[13],U=4==(4&S[13])?31:0,Q=1&S[13],T=2&S[13],E=z,V=0,Y=W[(O=31)^U],0!=j&&(F=Y),0!=q&&(P=Y),0!=C&&(L=Y))}}function $(e,r,n){return w=r,function(e){_=32768*w*8/e}(e),function(e,r){var n;for(r&=255,63,n=63;r>0;)r--,1.023292992,n*=1.023292992;for(var a=31;a>=0;a--)W[a]=n>63?63:Math.round(n),1.188502227,n/=1.188502227;W[63]=63}(0,12),function(){0,H=0,J=0,K=0,N=255,y=0,A=0,R=0,x=0,z=0,B=0,D=0,G=0,I=0,E=0,F=0,P=0,L=0,Y=0,j=0,q=0,C=0,O=0,Q=0,T=0,V=0,U=0;for(var e=0;e<=14;e++)Z(e,0)}(),0}$(a/2,t,8);for(var ee=0,re=new Array(1024),ne=0;ne<1024;ne++)re[ne]=Math.round(510*Math.random());function ae(){var e,r,n,a,o;e=0,r=0,n=0,a=32768;do{if(o=0,o=I<a?I:a,8==(8&X)){for(1==H&&(e+=B),B-=o;B<=0;){if((B+=y)>0){0==(1&S[7])&&(H^=1),0!=H&&(e+=y);break}B+=y,e+=y}1==H&&(e-=B)}else for(B-=o;B<=0;){if((B+=y)>0){H^=1;break}B+=y}if(16==(16&X)){for(1==J&&(r+=D),D-=o;D<=0;){if((D+=A)>0){0==(2&S[7])&&(J^=1),0!=J&&(r+=A);break}D+=A,r+=A}1==J&&(r-=D)}else for(D-=o;D<=0;){if((D+=A)>0){J^=1;break}D+=A}if(32==(32&X)){for(1==K&&(n+=G),G-=o;G<=0;){if((G+=R)>0){0==(4&S[7])&&(K^=1),0!=K&&(n+=R);break}G+=R,n+=R}1==K&&(n-=G)}else for(G-=o;G<=0;){if((G+=R)>0){K^=1;break}G+=R}(I-=o)<=0&&(N=re[ee=(ee+1)%1024],X=N|S[7],I+=x),a-=o}while(a>0);if(0==V&&(E-=32768)<=0){do{O-=1,E+=z}while(E<=0);O<0&&(0!=Q?(0!=T&&(U^=31),V=1,O=0):(0!=T&32==(32&O)&&(U^=31),O&=31)),Y=W[O^U],0!=j&&(F=Y),0!=q&&(P=Y),0!=C&&(L=Y)}return(e*F/65535+r*P/65535+n*L/65535)/63}var oe=performance.now(),te=0,fe=0;function se(e){if(f){e=Math.floor(e);var r=p;M.length<p+e&&(M.length+=Math.max(65536,e)),p+=e;for(var n=r;n<p;n++,b++,v++)25==v&&(1==(1&S[7])?(B<=13107200&&(B+=13107200),H=1):0==S[8]&&B<=13107200&&(B+=13107200),2==(2&S[7])?(D<=13107200&&(D+=13107200),J=1):0==S[9]&&D<=13107200&&(D+=13107200),4==(4&S[7])?(G<=13107200&&(G+=13107200),K=1):0==S[10]&&G<=13107200&&(G+=13107200),56==(56&S[7])&&I<=13107200&&(I+=13107200),X=N|S[7],v=0),M[n]=ae()}}return r.fillBuffer=function(){for(var e=new Array(s),r=0,a=0;a<s;a++){for(var o=0,t=0;t<8&&r<d;t++,r++)o+=u[r];o/=t||1,o*=.7,o+=M[a]/2,e[a]=o}if((r=8*s)>=d)te+=r-d,d=0;else{d-=r;for(a=0;a<d;a++)u[a]=u[a+r]}if(s>=p)p=0;else{p-=s;for(a=0;a<p;a++)M[a]=M[a+s]}if(n){var f=performance.now();f-oe>5e3&&(console.log("Sound data tail "+(d+p)+", skipped "+te+", correction "+fe),oe=f,te=0,fe=0)}return e},r.updateBuzzer=function(e,n){0==e&&(e=-1);var o=(n-m)*t*8/a;r.createSoundData(o,i),i=e,m=n},r.createSoundData=function(e,r){if(f&&(e=Math.floor(e))>0){var n=d+e;u.length<n&&(u.length+=Math.max(65536,e)),u.fill(r,d,n),d=n,l+=e}},r.endFrame=function(){var e=0;m&&(e=i);var n=0;const a=.1*t*8;d<a&&(n=a-d)&&(fe+=n,n=Math.min(n,s),n=8*Math.floor(n/8)),r.createSoundData(8*c-l+n,e),n=0,8*p<a&&(n=a-8*p)&&(fe+=n,n=Math.min(n,s),n=8*Math.floor(n/8)),se(c-b+n/8),m=0,g=0,l=0,b=0,h++<2||f&&postMessage(["notifyReady",d/8])},r.selectSoundRegister=function(e){k=e},r.writeSoundRegister=function(e,r){se((r-g)*t/a),g=r,Z(k,e)},r.readSoundRegister=function(){return S[k]},r.reset=function(){X=0,$(a/2,t)},r.setEnabled=function(e){f=e},r},onmessage=function(e){if(self.opts&&self.opts.debugPrint){var r=performance.now();self.commands_count=(self.commands_count||0)+e.data.length,self.prev_time=self.prev_time||r,r-self.prev_time>5e3&&(console.log("Sound worker received ",self.commands_count," AY8912 commands, ",(1e3*self.commands_count/(r-self.prev_time)).toFixed(2)," commands per sec"),self.prev_time=r,self.commands_count=0)}for(var n of e.data){if("SoundGenerator"===n[0])self.snd_gen=SoundGenerator.apply(null,n[1]),self.opts=n[1][0];else{var a=function(e){return self.snd_gen[e[0]].apply(null,e[1])}(n);a&&postMessage([n[0],a])}}};

SoundGenerator=function(e){var n={},r=(e=e||{}).debugPrint||!1,a=e.model.clockSpeed,o=e.model.frameLength,t=e.backendSampleRate||44100,f=e.backendEnabled||!1,s=e.backendAudioBufferSize||1024,c=Math.floor(t*o/a),i=0,u=new Array,l=0,d=0,h=0,m=0,v=0,g=new Array,p=0,M=0,b=0,k=0,w=(new Int32Array(16),0),S=new Int32Array(16),_=0,y=0,A=0,R=0,z=0,B=0,D=0,G=0,I=0,E=0,F=0,P=0,x=0,L=0,Y=0,j=0,q=0,C=0,H=0,J=0,K=0,N=0,O=0,Q=0,T=0,U=0,V=0,W=new Int32Array(64),X=0;function Z(e,n){var r;switch(S[e]=n,e){case 0:case 1:S[1]=15&S[1],r=y,0==(y=Math.round((S[0]+256*S[1])*_))&&(y=Math.round(_)),(D+=y-r)<=0&&(D=1);break;case 2:case 3:S[3]=15&S[3],r=A,0==(A=Math.round((S[2]+256*S[3])*_))&&(A=Math.round(_)),(G=G+A-r)<=0&&(G=1);break;case 4:case 5:S[5]=15&S[5],r=R,0==(R=Math.round((S[4]+256*S[5])*_))&&(R=Math.round(_)),(I+=R-r)<=0&&(I=1);break;case 6:S[6]=31&S[6],r=z,0==(z=Math.round(S[6]*_))&&(z=Math.round(_)),(E+=z-r)<=0&&(E=1);break;case 8:S[8]=31&S[8],j=16&S[8],P=0!=j?Y:0!=S[8]?W[2*S[8]+1]:W[0];break;case 9:S[9]=31&S[9],q=16&S[9],x=0!=q?Y:0!=S[9]?W[2*S[9]+1]:W[0];break;case 10:S[10]=31&S[10],C=16&S[10],L=0!=C?Y:0!=S[10]?W[2*S[10]+1]:W[0];break;case 11:case 12:r=B,0==(B=Math.round((S[11]+256*S[12])*_))&&(B=Math.round(_/2)),(F+=B-r)<=0&&(F=1);break;case 13:255!=S[13]&&(S[13]=15&S[13],U=4==(4&S[13])?31:0,Q=1&S[13],T=2&S[13],F=B,V=0,Y=W[(O=31)^U],0!=j&&(P=Y),0!=q&&(x=Y),0!=C&&(L=Y))}}function $(e,n,r){return w=n,function(e){_=32768*w*8/e}(e),function(e,n){var r;for(n&=255,63,r=63;n>0;)n--,1.023292992,r*=1.023292992;for(var a=31;a>=0;a--)W[a]=r>63?63:Math.round(r),1.188502227,r/=1.188502227;W[63]=63}(0,12),function(){0,H=0,J=0,K=0,N=255,y=0,A=0,R=0,z=0,B=0,D=0,G=0,I=0,E=0,F=0,P=0,x=0,L=0,Y=0,j=0,q=0,C=0,O=0,Q=0,T=0,V=0,U=0;for(var e=0;e<=14;e++)Z(e,0)}(),0}function ee(){var e,n,r,a,o;e=0,n=0,r=0,a=32768;do{if(o=0,o=E<a?E:a,8==(8&X)){for(1==H&&(e+=D),D-=o;D<=0;){if((D+=y)>0){0==(1&S[7])&&(H^=1),0!=H&&(e+=y);break}D+=y,e+=y}1==H&&(e-=D)}else for(D-=o;D<=0;){if((D+=y)>0){H^=1;break}D+=y}if(16==(16&X)){for(1==J&&(n+=G),G-=o;G<=0;){if((G+=A)>0){0==(2&S[7])&&(J^=1),0!=J&&(n+=A);break}G+=A,n+=A}1==J&&(n-=G)}else for(G-=o;G<=0;){if((G+=A)>0){J^=1;break}G+=A}if(32==(32&X)){for(1==K&&(r+=I),I-=o;I<=0;){if((I+=R)>0){0==(4&S[7])&&(K^=1),0!=K&&(r+=R);break}I+=R,r+=R}1==K&&(r-=I)}else for(I-=o;I<=0;){if((I+=R)>0){K^=1;break}I+=R}(E-=o)<=0&&(N=Math.round(510*Math.random()),X=N|S[7],E+=z),a-=o}while(a>0);if(0==V&&(F-=32768)<=0){do{O-=1,F+=B}while(F<=0);O<0&&(0!=Q?(0!=T&&(U^=31),V=1,O=0):(0!=T&32==(32&O)&&(U^=31),O&=31)),Y=W[O^U],0!=j&&(P=Y),0!=q&&(x=Y),0!=C&&(L=Y)}return(e*P/65535+n*x/65535+r*L/65535)/63}$(a/2,t,8);var ne=performance.now(),re=0,ae=0;function oe(e){if(f){e=Math.floor(e);var n=p;g.length<p+e&&(g.length+=e),p+=e;for(var r=n;r<p;r++,M++,v++)25==v&&(1==(1&S[7])?(D<=13107200&&(D+=13107200),H=1):0==S[8]&&D<=13107200&&(D+=13107200),2==(2&S[7])?(G<=13107200&&(G+=13107200),J=1):0==S[9]&&G<=13107200&&(G+=13107200),4==(4&S[7])?(I<=13107200&&(I+=13107200),K=1):0==S[10]&&I<=13107200&&(I+=13107200),56==(56&S[7])&&E<=13107200&&(E+=13107200),X=N|S[7],v=0),g[r]=ee()}}return n.fillBuffer=function(){for(var e=new Array(s),n=0,a=0;a<e.length;a++){for(var o=0,t=0;t<8&&n<l;t++,n++)o+=u[n];o/=t||1,o*=.7,o+=g[a]/2,e[a]=o}if((n=8*e.length)>=l)re+=n-l,l=0;else{l-=n;for(a=0;a<l;a++)u[a]=u[a+n]}if(e.length>=p)p=0;else{p-=e.length;for(a=0;a<p;a++)g[a]=g[a+e.length]}if(r){var f=performance.now();f-ne>5e3&&(console.log("Sound data tail "+(l+p)+", skipped "+re+", correction "+ae),ne=f,re=0,ae=0)}return e},n.updateBuzzer=function(e,r){0==e&&(e=-1);var o=(r-h)*t*8/a;n.createSoundData(o,i),i=e,h=r},n.createSoundData=function(e,n){if(f&&(e=Math.floor(e))>0){var r=l;u.length<l+e&&(u.length+=e),l+=e,u.fill(n,r,l),d+=e}},n.endFrame=function(){var e=0;h&&(e=i);var r=0;const a=.1*t*8;l<a&&(r=a-l)&&(ae+=r,r=Math.min(r,s),r=8*Math.floor(r/8)),n.createSoundData(8*c-d+r,e),r=0,8*p<a&&(r=a-8*p)&&(ae+=r,r=Math.min(r,s),r=8*Math.floor(r/8)),oe(c-M+r/8),h=0,k=0,d=0,M=0,m++<2||f&&postMessage(["notifyReady",l/8])},n.selectSoundRegister=function(e){b=e},n.writeSoundRegister=function(e,n){oe((n-k)*t/a),k=n,Z(b,e)},n.readSoundRegister=function(){return S[b]},n.reset=function(){X=0,$(a/2,t)},n.setEnabled=function(e){f=e},n},onmessage=function(e){if(self.opts&&self.opts.debugPrint){var n=performance.now();self.commands_count=(self.commands_count||0)+e.data.length,self.prev_time=self.prev_time||n,n-self.prev_time>5e3&&(console.log("Sound worker received ",self.commands_count," AY8912 commands, ",(1e3*self.commands_count/(n-self.prev_time)).toFixed(2)," commands per sec"),self.prev_time=n,self.commands_count=0)}for(var r of e.data){if("SoundGenerator"===r[0])self.snd_gen=SoundGenerator.apply(null,r[1]),self.opts=r[1][0];else{var a=function(e){return self.snd_gen[e[0]].apply(null,e[1])}(r);a&&postMessage([r[0],a])}}};

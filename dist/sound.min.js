/**
 * @license Sound routines for jsspeccy
 * General sound routines and 48k buzzer emulation written by Darren Coles
 * 128k Spectrum sound routines developed from DelphiSpec emulator (credits below).
 * (c) 2013 Darren Coles
 * 
 * Credits from DelphiSpec:
 * 
 *  Routines for emulating the 128K Spectrum's AY-3-8912 sound generator
 * 
 *  Author: James Bagg <chipmunk_uk_1@hotmail.com>
 * 
 *   With minor optimisations and mods by
 *           Chris Cowley <ccowley@grok.co.uk>
 * 
 *   Translation to Delphi Object Pascal by
 *           Jari Korhonen <jarit.korhonen@luukku.com>
 * 
 *   Buffer underrun protection by
 *           Mist Poryvaev <mist.poryvaev@gmail.com>
 * 
 *   Copyright (C)1999-2000 Grok Developments Ltd  and James Bagg
 *   http: * www.grok.co.uk/      http: * www.chipmunks-corner.co.uk
 *   This program is free software; you can redistribute it and/or
 *   modify it under the terms of the GNU General Public License
 *   as published by the Free Software Foundation; either version 2
 *   of the License, or (at your option) any later version.
 *   This program is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *   GNU General Public License for more details.
 * 
 *   You should have received a copy of the GNU General Public License
 *   along with this program; if not, write to the Free Software
 *   Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 * 
 * *******************************************************************************
*/
SoundGenerator=function(e){var n={},o=(e=e||{}).debugPrint||!1,a=e.model.clockSpeed,r=e.model.frameLength,t=e.backendSampleRate||44100,f=e.backendEnabled||!1,s=e.backendAudioBufferSize||1024,l=Math.floor(t*r/a);var i=0,u=new Float32Array(8*t),c=0,d=0,h=0,g=0,m=new Float32Array(t),v=0,p=0,M=0,b=0,k=0,S=new Int32Array(16),w=0,y=0,_=0,D=0,A=0,z=0,F=0,P=0,G=0,L=0,R=0,B=0,q=0,E=0,I=0,N=0,x=0,Y=0,j=0,C=0,H=0,J=0,K=0,O=0,Q=0,T=0,U=0,V=new Int32Array(64),W=0;function X(e,n){var o;switch(S[e]=n,e){case 0:case 1:S[1]=15&S[1],o=y,0==(y=Math.round((S[0]+256*S[1])*w))&&(y=Math.round(w)),(F+=y-o)<=0&&(F=1);break;case 2:case 3:S[3]=15&S[3],o=_,0==(_=Math.round((S[2]+256*S[3])*w))&&(_=Math.round(w)),(P=P+_-o)<=0&&(P=1);break;case 4:case 5:S[5]=15&S[5],o=D,0==(D=Math.round((S[4]+256*S[5])*w))&&(D=Math.round(w)),(G+=D-o)<=0&&(G=1);break;case 6:S[6]=31&S[6],o=A,0==(A=Math.round(S[6]*w))&&(A=Math.round(w)),(L+=A-o)<=0&&(L=1);break;case 8:S[8]=31&S[8],N=16&S[8],B=0!=N?I:0!=S[8]?V[2*S[8]+1]:V[0];break;case 9:S[9]=31&S[9],x=16&S[9],q=0!=x?I:0!=S[9]?V[2*S[9]+1]:V[0];break;case 10:S[10]=31&S[10],Y=16&S[10],E=0!=Y?I:0!=S[10]?V[2*S[10]+1]:V[0];break;case 11:case 12:o=z,0==(z=Math.round((S[11]+256*S[12])*w))&&(z=Math.round(w/2)),(R+=z-o)<=0&&(R=1);break;case 13:255!=S[13]&&(S[13]=15&S[13],T=4==(4&S[13])?31:0,O=1&S[13],Q=2&S[13],R=z,U=0,I=V[(K=31)^T],0!=N&&(B=I),0!=x&&(q=I),0!=Y&&(E=I))}}function Z(e,n,o){return k=n,function(e){w=32768*k*8/e}(e),function(e,n){var o;for(n&=255,63,o=63;n>0;)n--,1.023292992,o*=1.023292992;for(var a=31;a>=0;a--)V[a]=o>63?63:Math.round(o),1.188502227,o/=1.188502227;V[63]=63}(0,12),function(){i=0,c=0,d=0,h=0,g=0,0,v=0,p=0,0,j=0,C=0,H=0,J=255,y=0,_=0,D=0,A=0,z=0,F=0,P=0,G=0,L=0,R=0,B=0,q=0,E=0,I=0,N=0,x=0,Y=0,K=0,O=0,Q=0,U=0,T=0;for(var e=0;e<=14;e++)X(e,0)}(),0}Z(a/2,t,8);for(var $=0,ee=new Array(1024),ne=0;ne<1024;ne++)ee[ne]=Math.round(510*Math.random());function oe(){var e,n,o,a,r;e=0,n=0,o=0,a=32768;do{if(r=0,r=L<a?L:a,8==(8&W)){for(1==j&&(e+=F),F-=r;F<=0;){if((F+=y)>0){0==(1&S[7])&&(j^=1),0!=j&&(e+=y);break}F+=y,e+=y}1==j&&(e-=F)}else for(F-=r;F<=0;){if((F+=y)>0){j^=1;break}F+=y}if(16==(16&W)){for(1==C&&(n+=P),P-=r;P<=0;){if((P+=_)>0){0==(2&S[7])&&(C^=1),0!=C&&(n+=_);break}P+=_,n+=_}1==C&&(n-=P)}else for(P-=r;P<=0;){if((P+=_)>0){C^=1;break}P+=_}if(32==(32&W)){for(1==H&&(o+=G),G-=r;G<=0;){if((G+=D)>0){0==(4&S[7])&&(H^=1),0!=H&&(o+=D);break}G+=D,o+=D}1==H&&(o-=G)}else for(G-=r;G<=0;){if((G+=D)>0){H^=1;break}G+=D}(L-=r)<=0&&(J=ee[$=($+1)%1024],W=J|S[7],L+=A),a-=r}while(a>0);if(0==U&&(R-=32768)<=0){do{K-=1,R+=z}while(R<=0);K<0&&(0!=O?(0!=Q&&(T^=31),U=1,K=0):(0!=Q&32==(32&K)&&(T^=31),K&=31)),I=V[K^T],0!=N&&(B=I),0!=x&&(q=I),0!=Y&&(E=I)}return(e*B/65535+n*q/65535+o*E/65535)/63}var ae=performance.now(),re=0,te=0,fe=new Float32Array(s);function se(n){if(f&&(n=Math.floor(n))>0){const a=v+n;if(m.length>=a){for(var o=v;o<a;o++,g++)25==g&&(1==(1&S[7])?(F<=13107200&&(F+=13107200),j=1):0==S[8]&&F<=13107200&&(F+=13107200),2==(2&S[7])?(P<=13107200&&(P+=13107200),C=1):0==S[9]&&P<=13107200&&(P+=13107200),4==(4&S[7])?(G<=13107200&&(G+=13107200),H=1):0==S[10]&&G<=13107200&&(G+=13107200),56==(56&S[7])&&L<=13107200&&(L+=13107200),W=J|S[7],g=0),m[o]=oe();v=a,p+=n}else e.debugPrint&&(console.log("aySoundData.length",m.length,"aySoundDataLength + size",a),console.log("skip aySoundData")),v=0}}fe.fill(0),n.fillBuffer=function(){for(var n=0,a=0;a<s&&0<v;a++){for(var r=0,t=0;t<8&&n<c;t++,n++)r+=u[n];r=t>0?r/t:0,r*=.7,(r+=m[a]/2)!=r&&e.debugPrint&&(console.log("Sound worker said NaN is here: avg=",r,",aySoundData",m[a],",i",a,",aySoundDataLength",v,",aySoundData.length",m.length),r=0),fe[a]=r}if(fe.fill(0,a),(n=8*s)>=c)re+=n-c,c=0;else{c-=n;for(a=0;a<c;a++)u[a]=u[a+n]}if(s>=v)v=0;else{v-=s;for(a=0;a<v;a++)m[a]=m[a+s]}if(o){var f=performance.now();f-ae>5e3&&(console.log("Sound data tail "+(c+v)+", skipped "+re+", correction "+te),ae=f,re=0,te=0)}return fe};const le=8*t/a;n.updateBuzzer=function(e,n){ie((n-h)*le,i),i=e<=0?-1:1,h=n};var ie=function(n,o){if(f&&(n=Math.floor(n))>0){const a=c+n;if(!(u.length>=a))return e.debugPrint&&(console.log("soundData.length",u.length,"soundDataLength + size",a),console.log("skip soundData")),void(c=0);u.fill(o,c,a),c=a,d+=n}};return n.endFrame=function(){var e=0;const n=128*Math.sqrt(s)*8;c<n&&(e=n-c)&&(te+=e,e=Math.min(e,s),e=8*Math.floor(e/8));const o=Math.floor(8*l-d+e);if(o>0){var a=0;h&&(a=i),ie(o,a)}e=0,8*v<n&&(e=n-8*v)&&(te+=e,e=Math.min(e,s),e=8*Math.floor(e/8));const r=Math.floor(l-p+e/8);r>0&&se(r),h=0,b=0,d=0,p=0},n.selectSoundRegister=function(e){M=e},n.writeSoundRegister=function(e,n){se((n-b)*t/a),b=n,X(M,e)},n.readSoundRegister=function(){return S[M]},n.reset=function(){W=0,Z(a/2,t)},n.setEnabled=function(e){f=e},n},self.onmessage=function(e){for(var n of e.data)if("SoundGenerator"===n[0])self.snd_gen=SoundGenerator.apply(null,n[1]),self.opts=n[1][0];else if(self.snd_gen){var o=self.snd_gen[n[0]].apply(null,n[1]);o&&self.postMessage([n[0],o])}else self.postMessage(["requestSoundGenerator",null]);if(self.opts&&self.opts.debugPrint){var a=performance.now();self.commands_count=(self.commands_count||0)+e.data.length,self.prev_time=self.prev_time||a,a-self.prev_time>5e3&&(console.log("Sound worker received ",self.commands_count," AY8912 commands, ",(1e3*self.commands_count/(a-self.prev_time)).toFixed(2)," commands per sec"),self.prev_time=a,self.commands_count=0)}};

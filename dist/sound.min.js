SoundGenerator=function(e){var n={},a=(e=e||{}).debugPrint||!1,r=e.model.clockSpeed,t=e.model.frameLength,o=e.backendSampleRate||44100,f=e.backendEnabled||!1,u=e.backendAudioBufferSize||1024,i=Math.floor(o*t/r),l=0,c=new Array,d=0,s=0,h=0,g=0,b=new Array,M=0,k=0,v=0,p=(new Int32Array(16),0),w=new Int32Array(16),S=0,y=0,m=0,A=0,R=0,z=0,B=0,D=0,G=0,I=0,E=0,_=0,F=0,L=0,P=0,j=0,q=0,x=0,C=0,H=0,J=0,K=0,N=0,O=0,Q=0,T=0,U=0,V=new Int32Array(64),W=0;function X(e,n){var a;switch(w[e]=n,e){case 0:case 1:w[1]=15&w[1],a=y,0==(y=Math.round((w[0]+256*w[1])*S))&&(y=Math.round(S)),(B+=y-a)<=0&&(B=1);break;case 2:case 3:w[3]=15&w[3],a=m,0==(m=Math.round((w[2]+256*w[3])*S))&&(m=Math.round(S)),(D=D+m-a)<=0&&(D=1);break;case 4:case 5:w[5]=15&w[5],a=A,0==(A=Math.round((w[4]+256*w[5])*S))&&(A=Math.round(S)),(G+=A-a)<=0&&(G=1);break;case 6:w[6]=31&w[6],a=R,0==(R=Math.round(w[6]*S))&&(R=Math.round(S)),(I+=R-a)<=0&&(I=1);break;case 8:w[8]=31&w[8],j=16&w[8],_=0!=j?P:0!=w[8]?V[2*w[8]+1]:V[0];break;case 9:w[9]=31&w[9],q=16&w[9],F=0!=q?P:0!=w[9]?V[2*w[9]+1]:V[0];break;case 10:w[10]=31&w[10],x=16&w[10],L=0!=x?P:0!=w[10]?V[2*w[10]+1]:V[0];break;case 11:case 12:a=z,0==(z=Math.round((w[11]+256*w[12])*S))&&(z=Math.round(S/2)),(E+=z-a)<=0&&(E=1);break;case 13:255!=w[13]&&(w[13]=15&w[13],T=4==(4&w[13])?31:0,O=1&w[13],Q=2&w[13],E=z,U=0,P=V[(N=31)^T],0!=j&&(_=P),0!=q&&(F=P),0!=x&&(L=P))}}function Y(e,n,a){return p=n,function(e){S=32768*p*8/e}(e),function(e,n){var a;for(n&=255,63,a=63;n>0;)n--,1.023292992,a*=1.023292992;for(var r=31;r>=0;r--)V[r]=a>63?63:Math.round(a),1.188502227,a/=1.188502227;V[63]=63}(0,12),function(){0,C=0,H=0,J=0,K=255,y=0,m=0,A=0,R=0,z=0,B=0,D=0,G=0,I=0,E=0,_=0,F=0,L=0,P=0,j=0,q=0,x=0,N=0,O=0,Q=0,U=0,T=0;for(var e=0;e<=14;e++)X(e,0)}(),0}function Z(){var e,n,a,r,t;e=0,n=0,a=0,r=32768;do{if(t=0,t=I<r?I:r,8==(8&W)){for(1==C&&(e+=B),B-=t;B<=0;){if((B+=y)>0){0==(1&w[7])&&(C^=1),0!=C&&(e+=y);break}B+=y,e+=y}1==C&&(e-=B)}else for(B-=t;B<=0;){if((B+=y)>0){C^=1;break}B+=y}if(16==(16&W)){for(1==H&&(n+=D),D-=t;D<=0;){if((D+=m)>0){0==(2&w[7])&&(H^=1),0!=H&&(n+=m);break}D+=m,n+=m}1==H&&(n-=D)}else for(D-=t;D<=0;){if((D+=m)>0){H^=1;break}D+=m}if(32==(32&W)){for(1==J&&(a+=G),G-=t;G<=0;){if((G+=A)>0){0==(4&w[7])&&(J^=1),0!=J&&(a+=A);break}G+=A,a+=A}1==J&&(a-=G)}else for(G-=t;G<=0;){if((G+=A)>0){J^=1;break}G+=A}(I-=t)<=0&&(K=Math.round(510*Math.random()),W=K|w[7],I+=R),r-=t}while(r>0);if(0==U&&(E-=32768)<=0){do{N-=1,E+=z}while(E<=0);N<0&&(0!=O?(0!=Q&&(T^=31),U=1,N=0):(0!=Q&32==(32&N)&&(T^=31),N&=31)),P=V[N^T],0!=j&&(_=P),0!=q&&(F=P),0!=x&&(L=P)}return(e*_/65535+n*F/65535+a*L/65535)/63}Y(r/2,o,8);var $=performance.now(),ee=0,ne=0;function ae(e){if(f){e=Math.floor(e);var n=b.length;b.length+=e;for(var a=n;a<b.length;a++,M++,g++)25==g&&(1==(1&w[7])?(B<=13107200&&(B+=13107200),C=1):0==w[8]&&B<=13107200&&(B+=13107200),2==(2&w[7])?(D<=13107200&&(D+=13107200),H=1):0==w[9]&&D<=13107200&&(D+=13107200),4==(4&w[7])?(G<=13107200&&(G+=13107200),J=1):0==w[10]&&G<=13107200&&(G+=13107200),56==(56&w[7])&&I<=13107200&&(I+=13107200),W=K|w[7],g=0),b[a]=Z()}}return n.fillBuffer=function(){for(var e=new Array(u),n=0,r=0;r<e.length;r++){for(var t=0,o=0;o<8&&n<c.length;o++,n++)t+=c[n];t/=o||1,t*=.7,t+=b[r]/2,e[r]=t}if((n=8*e.length)>=c.length?(ee+=n-c.length,c=new Array):c.splice(0,n),e.length>=b.length?b=new Array:b.splice(0,e.length),a){var f=performance.now();f-$>5e3&&(console.log("Sound data tail "+c.length+", skipped "+ee+", correction "+ne),$=f,ee=0,ne=0)}return e},n.updateBuzzer=function(e,a){if(0==e&&(e=-1),l!=e){var t=(a-s)*o*8/r;n.createSoundData(t,l),l=e,s=a}},n.createSoundData=function(e,n){if(f&&(e=Math.floor(e))>0){var a=c.length;c.length+=e,c.fill(n,a),d+=e}},n.endFrame=function(){var e=0;s&&(e=l);var a=0;const r=.1*o*8;c.length<r&&(a=r-c.length,ne+=a,a&&(a=Math.min(a,u)));a=8*Math.floor(a/8),n.createSoundData(8*i-d+a,e),ae(i-M+a/8),s=0,v=0,d=0,M=0,h++<2||f&&postMessage(["notifyReady",c.length/8])},n.selectSoundRegister=function(e){k=e},n.writeSoundRegister=function(e,n){ae((n-v)*o/r),v=n,X(k,e)},n.readSoundRegister=function(){return w[k]},n.reset=function(){W=0,Y(r/2,o)},n.setEnabled=function(e){f=e},n},onmessage=function(e){if("SoundGenerator"===e.data[0]){var n=e.data[1];self.snd_gen=SoundGenerator.apply(null,n)}else{var a=function(e){var n=e.data[1];return self.snd_gen[e.data[0]].apply(null,n)}(e);a&&postMessage([e.data[0],a])}};

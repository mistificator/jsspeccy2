SoundGenerator=function(e){var n={},r=(e=e||{}).debugPrint||!1,a=e.model.clockSpeed,o=e.model.frameLength,t=e.backendSampleRate||44100,f=e.backendEnabled||!1,l=e.backendAudioBufferSize||1024,c=Math.floor(t*o/a),s=0,u=new Array,i=0,d=0,h=0,g=0,m=new Array,p=0,v=0,b=0,k=(new Int32Array(16),0),M=new Int32Array(16),w=0,S=0,y=0,_=0,A=0,R=0,z=0,B=0,D=0,G=0,I=0,E=0,F=0,P=0,x=0,L=0,Y=0,j=0,q=0,C=0,H=0,J=0,K=0,N=0,O=0,Q=0,T=0,U=new Int32Array(64),V=0;function W(e,n){var r;switch(M[e]=n,e){case 0:case 1:M[1]=15&M[1],r=S,0==(S=Math.round((M[0]+256*M[1])*w))&&(S=Math.round(w)),(z+=S-r)<=0&&(z=1);break;case 2:case 3:M[3]=15&M[3],r=y,0==(y=Math.round((M[2]+256*M[3])*w))&&(y=Math.round(w)),(B=B+y-r)<=0&&(B=1);break;case 4:case 5:M[5]=15&M[5],r=_,0==(_=Math.round((M[4]+256*M[5])*w))&&(_=Math.round(w)),(D+=_-r)<=0&&(D=1);break;case 6:M[6]=31&M[6],r=A,0==(A=Math.round(M[6]*w))&&(A=Math.round(w)),(G+=A-r)<=0&&(G=1);break;case 8:M[8]=31&M[8],L=16&M[8],E=0!=L?x:0!=M[8]?U[2*M[8]+1]:U[0];break;case 9:M[9]=31&M[9],Y=16&M[9],F=0!=Y?x:0!=M[9]?U[2*M[9]+1]:U[0];break;case 10:M[10]=31&M[10],j=16&M[10],P=0!=j?x:0!=M[10]?U[2*M[10]+1]:U[0];break;case 11:case 12:r=R,0==(R=Math.round((M[11]+256*M[12])*w))&&(R=Math.round(w/2)),(I+=R-r)<=0&&(I=1);break;case 13:255!=M[13]&&(M[13]=15&M[13],Q=4==(4&M[13])?31:0,N=1&M[13],O=2&M[13],I=R,T=0,x=U[(K=31)^Q],0!=L&&(E=x),0!=Y&&(F=x),0!=j&&(P=x))}}function X(e,n,r){return k=n,function(e){w=32768*k*8/e}(e),function(e,n){var r;for(n&=255,63,r=63;n>0;)n--,1.023292992,r*=1.023292992;for(var a=31;a>=0;a--)U[a]=r>63?63:Math.round(r),1.188502227,r/=1.188502227;U[63]=63}(0,12),function(){0,q=0,C=0,H=0,J=255,S=0,y=0,_=0,A=0,R=0,z=0,B=0,D=0,G=0,I=0,E=0,F=0,P=0,x=0,L=0,Y=0,j=0,K=0,N=0,O=0,T=0,Q=0;for(var e=0;e<=14;e++)W(e,0)}(),0}function Z(){var e,n,r,a,o;e=0,n=0,r=0,a=32768;do{if(o=0,o=G<a?G:a,8==(8&V)){for(1==q&&(e+=z),z-=o;z<=0;){if((z+=S)>0){0==(1&M[7])&&(q^=1),0!=q&&(e+=S);break}z+=S,e+=S}1==q&&(e-=z)}else for(z-=o;z<=0;){if((z+=S)>0){q^=1;break}z+=S}if(16==(16&V)){for(1==C&&(n+=B),B-=o;B<=0;){if((B+=y)>0){0==(2&M[7])&&(C^=1),0!=C&&(n+=y);break}B+=y,n+=y}1==C&&(n-=B)}else for(B-=o;B<=0;){if((B+=y)>0){C^=1;break}B+=y}if(32==(32&V)){for(1==H&&(r+=D),D-=o;D<=0;){if((D+=_)>0){0==(4&M[7])&&(H^=1),0!=H&&(r+=_);break}D+=_,r+=_}1==H&&(r-=D)}else for(D-=o;D<=0;){if((D+=_)>0){H^=1;break}D+=_}(G-=o)<=0&&(J=Math.round(510*Math.random()),V=J|M[7],G+=A),a-=o}while(a>0);if(0==T&&(I-=32768)<=0){do{K-=1,I+=R}while(I<=0);K<0&&(0!=N?(0!=O&&(Q^=31),T=1,K=0):(0!=O&32==(32&K)&&(Q^=31),K&=31)),x=U[K^Q],0!=L&&(E=x),0!=Y&&(F=x),0!=j&&(P=x)}return(e*E/65535+n*F/65535+r*P/65535)/63}X(a/2,t,8);var $=performance.now(),ee=0,ne=0;function re(e){if(f){e=Math.floor(e);var n=m.length;m.length+=e;for(var r=n;r<m.length;r++,p++,g++)25==g&&(1==(1&M[7])?(z<=13107200&&(z+=13107200),q=1):0==M[8]&&z<=13107200&&(z+=13107200),2==(2&M[7])?(B<=13107200&&(B+=13107200),C=1):0==M[9]&&B<=13107200&&(B+=13107200),4==(4&M[7])?(D<=13107200&&(D+=13107200),H=1):0==M[10]&&D<=13107200&&(D+=13107200),56==(56&M[7])&&G<=13107200&&(G+=13107200),V=J|M[7],g=0),m[r]=Z()}}return n.fillBuffer=function(){for(var e=new Array(l),n=0,a=0;a<e.length;a++){for(var o=0,t=0;t<8&&n<u.length;t++,n++)o+=u[n];o/=t||1,o*=.7,o+=m[a]/2,e[a]=o}if((n=8*e.length)>=u.length?(ee+=n-u.length,u=new Array):u.splice(0,n),e.length>=m.length?m=new Array:m.splice(0,e.length),r){var f=performance.now();f-$>5e3&&(console.log("Sound data tail "+u.length+", skipped "+ee+", correction "+ne),$=f,ee=0,ne=0)}return e},n.updateBuzzer=function(e,r){0==e&&(e=-1);var o=(r-d)*t*8/a;n.createSoundData(o,s),s=e,d=r},n.createSoundData=function(e,n){if(f&&(e=Math.floor(e))>0){var r=u.length;u.length+=e,u.fill(n,r),i+=e}},n.endFrame=function(){var e=0;d&&(e=s);var r=0;const a=.1*t*8;u.length<a&&(r=a-u.length,ne+=r,r&&(r=Math.min(r,l)));r=8*Math.floor(r/8),n.createSoundData(8*c-i+r,e),re(c-p+r/8),d=0,b=0,i=0,p=0,h++<2||f&&postMessage(["notifyReady",u.length/8])},n.selectSoundRegister=function(e){v=e},n.writeSoundRegister=function(e,n){re((n-b)*t/a),b=n,W(v,e)},n.readSoundRegister=function(){return M[v]},n.reset=function(){V=0,X(a/2,t)},n.setEnabled=function(e){f=e},n},onmessage=function(e){if(self.opts&&self.opts.debugPrint){var n=performance.now();self.commands_count=(self.commands_count||0)+e.data.length,self.prev_time=self.prev_time||n,n-self.prev_time>5e3&&(console.log("Sound worker received ",self.commands_count," AY8912 commands, ",(1e3*self.commands_count/(n-self.prev_time)).toFixed(2)," commands per sec"),self.prev_time=n,self.commands_count=0)}for(var r of e.data){if("SoundGenerator"===r[0])self.snd_gen=SoundGenerator.apply(null,r[1]),self.opts=r[1][0];else{var a=function(e){return self.snd_gen[e[0]].apply(null,e[1])}(r);a&&postMessage([r[0],a])}}};

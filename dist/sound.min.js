/**
 * @license Sound routines for jsspeccy
 * General sound routines and 48k buzzer emulation written by Darren Coles
 * 128k Spectrum sound routines developed from DelphiSpec emulator (credits below).
 * (c) 2013 Darren Coles
 * 
 * Credits from DelphiSpec:
 * 
 *  Routines for emulating the 128K Spectrum's AY-3-8912 sound generator
 * 
 *  Author: James Bagg <chipmunk_uk_1@hotmail.com>
 * 
 *   With minor optimisations and mods by
 *           Chris Cowley <ccowley@grok.co.uk>
 * 
 *   Translation to Delphi Object Pascal by
 *           Jari Korhonen <jarit.korhonen@luukku.com>
 * 
 *   Buffer underrun protection by
 *           Mist Poryvaev <mist.poryvaev@gmail.com>
 * 
 *   Copyright (C)1999-2000 Grok Developments Ltd  and James Bagg
 *   http: * www.grok.co.uk/      http: * www.chipmunks-corner.co.uk
 *   This program is free software; you can redistribute it and/or
 *   modify it under the terms of the GNU General Public License
 *   as published by the Free Software Foundation; either version 2
 *   of the License, or (at your option) any later version.
 *   This program is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *   GNU General Public License for more details.
 * 
 *   You should have received a copy of the GNU General Public License
 *   along with this program; if not, write to the Free Software
 *   Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 * 
 * *******************************************************************************
*/
SoundGenerator=function(e){var r={},n=(e=e||{}).debugPrint||!1,a=e.model.clockSpeed,o=e.model.frameLength,t=e.backendSampleRate||44100,f=e.backendEnabled||!1,s=e.backendAudioBufferSize||1024,i=Math.floor(t*o/a);var l=0,u=new Array,c=0,d=0,h=0,m=0,v=0,g=new Array,M=0,p=0,b=0,k=0,w=(new Int32Array(16),0),S=new Int32Array(16),y=0,_=0,A=0,R=0,x=0,z=0,B=0,D=0,F=0,G=0,I=0,P=0,E=0,L=0,N=0,q=0,Y=0,j=0,C=0,H=0,J=0,K=0,O=0,Q=0,T=0,U=0,V=0,W=new Int32Array(64),X=0;function Z(e,r){var n;switch(S[e]=r,e){case 0:case 1:S[1]=15&S[1],n=_,0==(_=Math.round((S[0]+256*S[1])*y))&&(_=Math.round(y)),(B+=_-n)<=0&&(B=1);break;case 2:case 3:S[3]=15&S[3],n=A,0==(A=Math.round((S[2]+256*S[3])*y))&&(A=Math.round(y)),(D=D+A-n)<=0&&(D=1);break;case 4:case 5:S[5]=15&S[5],n=R,0==(R=Math.round((S[4]+256*S[5])*y))&&(R=Math.round(y)),(F+=R-n)<=0&&(F=1);break;case 6:S[6]=31&S[6],n=x,0==(x=Math.round(S[6]*y))&&(x=Math.round(y)),(G+=x-n)<=0&&(G=1);break;case 8:S[8]=31&S[8],q=16&S[8],P=0!=q?N:0!=S[8]?W[2*S[8]+1]:W[0];break;case 9:S[9]=31&S[9],Y=16&S[9],E=0!=Y?N:0!=S[9]?W[2*S[9]+1]:W[0];break;case 10:S[10]=31&S[10],j=16&S[10],L=0!=j?N:0!=S[10]?W[2*S[10]+1]:W[0];break;case 11:case 12:n=z,0==(z=Math.round((S[11]+256*S[12])*y))&&(z=Math.round(y/2)),(I+=z-n)<=0&&(I=1);break;case 13:255!=S[13]&&(S[13]=15&S[13],U=4==(4&S[13])?31:0,Q=1&S[13],T=2&S[13],I=z,V=0,N=W[(O=31)^U],0!=q&&(P=N),0!=Y&&(E=N),0!=j&&(L=N))}}function $(e,r,n){return w=r,function(e){y=32768*w*8/e}(e),function(e,r){var n;for(r&=255,63,n=63;r>0;)r--,1.023292992,n*=1.023292992;for(var a=31;a>=0;a--)W[a]=n>63?63:Math.round(n),1.188502227,n/=1.188502227;W[63]=63}(0,12),function(){l=0,c=0,d=0,h=0,m=0,v=0,0,M=0,p=0,0,C=0,H=0,J=0,K=255,_=0,A=0,R=0,x=0,z=0,B=0,D=0,F=0,G=0,I=0,P=0,E=0,L=0,N=0,q=0,Y=0,j=0,O=0,Q=0,T=0,V=0,U=0;for(var e=0;e<=14;e++)Z(e,0)}(),0}$(a/2,t,8);for(var ee=0,re=new Array(1024),ne=0;ne<1024;ne++)re[ne]=Math.round(510*Math.random());function ae(){var e,r,n,a,o;e=0,r=0,n=0,a=32768;do{if(o=0,o=G<a?G:a,8==(8&X)){for(1==C&&(e+=B),B-=o;B<=0;){if((B+=_)>0){0==(1&S[7])&&(C^=1),0!=C&&(e+=_);break}B+=_,e+=_}1==C&&(e-=B)}else for(B-=o;B<=0;){if((B+=_)>0){C^=1;break}B+=_}if(16==(16&X)){for(1==H&&(r+=D),D-=o;D<=0;){if((D+=A)>0){0==(2&S[7])&&(H^=1),0!=H&&(r+=A);break}D+=A,r+=A}1==H&&(r-=D)}else for(D-=o;D<=0;){if((D+=A)>0){H^=1;break}D+=A}if(32==(32&X)){for(1==J&&(n+=F),F-=o;F<=0;){if((F+=R)>0){0==(4&S[7])&&(J^=1),0!=J&&(n+=R);break}F+=R,n+=R}1==J&&(n-=F)}else for(F-=o;F<=0;){if((F+=R)>0){J^=1;break}F+=R}(G-=o)<=0&&(K=re[ee=(ee+1)%1024],X=K|S[7],G+=x),a-=o}while(a>0);if(0==V&&(I-=32768)<=0){do{O-=1,I+=z}while(I<=0);O<0&&(0!=Q?(0!=T&&(U^=31),V=1,O=0):(0!=T&32==(32&O)&&(U^=31),O&=31)),N=W[O^U],0!=q&&(P=N),0!=Y&&(E=N),0!=j&&(L=N)}return(e*P/65535+r*E/65535+n*L/65535)/63}var oe=performance.now(),te=0,fe=0,se=new Float32Array(s);function ie(e){if(f){e=Math.floor(e);var r=M;g.length<M+e&&(g.length+=Math.max(65536,e)),M+=e;for(var n=r;n<M;n++,p++,v++)25==v&&(1==(1&S[7])?(B<=13107200&&(B+=13107200),C=1):0==S[8]&&B<=13107200&&(B+=13107200),2==(2&S[7])?(D<=13107200&&(D+=13107200),H=1):0==S[9]&&D<=13107200&&(D+=13107200),4==(4&S[7])?(F<=13107200&&(F+=13107200),J=1):0==S[10]&&F<=13107200&&(F+=13107200),56==(56&S[7])&&G<=13107200&&(G+=13107200),X=K|S[7],v=0),g[n]=ae()}}se.fill(0),r.fillBuffer=function(){for(var r=0,a=0;a<s&&0<M;a++){for(var o=0,t=0;t<8&&r<c;t++,r++)o+=u[r];o=t>0?o/t:0,o*=.7,(o+=g[a]/2)!=o&&e.debugPrint&&(console.log("Sound worker said NaN is here: avg=",o,",aySoundData",g[a],",i",a,",aySoundDataLength",M,",aySoundData.length",g.length),o=0),se[a]=o}if(se.fill(0,a),(r=8*s)>=c)te+=r-c,c=0;else{c-=r;for(a=0;a<c;a++)u[a]=u[a+r]}if(s>=M)M=0;else{M-=s;for(a=0;a<M;a++)g[a]=g[a+s]}if(n){var f=performance.now();f-oe>5e3&&(console.log("Sound data tail "+(c+M)+", skipped "+te+", correction "+fe),oe=f,te=0,fe=0)}return se},r.updateBuzzer=function(e,r){0==e&&(e=-1),le((r-h)*t*8/a,l),l=e,h=r};var le=function(e,r){if(f&&(e=Math.floor(e))>0){var n=c+e;u.length<n&&(u.length+=Math.max(65536,e)),u.fill(r,c,n),c=n,d+=e}};return r.endFrame=function(){var e=0;h&&(e=l);var r=0;const n=128*Math.sqrt(s)*8;c<n&&(r=n-c)&&(fe+=r,r=Math.min(r,s),r=8*Math.floor(r/8)),le(8*i-d+r,e),r=0,8*M<n&&(r=n-8*M)&&(fe+=r,r=Math.min(r,s),r=8*Math.floor(r/8)),ie(i-p+r/8),h=0,k=0,d=0,p=0,m++<2||f&&postMessage(["notifyReady",c/8])},r.selectSoundRegister=function(e){b=e},r.writeSoundRegister=function(e,r){ie((r-k)*t/a),k=r,Z(b,e)},r.readSoundRegister=function(){return S[b]},r.reset=function(){X=0,$(a/2,t)},r.setEnabled=function(e){f=e},r},onmessage=function(e){if(self.opts&&self.opts.debugPrint){var r=performance.now();self.commands_count=(self.commands_count||0)+e.data.length,self.prev_time=self.prev_time||r,r-self.prev_time>5e3&&(console.log("Sound worker received ",self.commands_count," AY8912 commands, ",(1e3*self.commands_count/(r-self.prev_time)).toFixed(2)," commands per sec"),self.prev_time=r,self.commands_count=0)}for(var n of e.data){if("SoundGenerator"===n[0])self.snd_gen=SoundGenerator.apply(null,n[1]),self.opts=n[1][0];else if(self.snd_gen){var a=function(e){return self.snd_gen[e[0]].apply(null,e[1])}(n);a&&postMessage([n[0],a])}}};

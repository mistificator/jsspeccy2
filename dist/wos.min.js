function WoS(){var t={cors_proxy:"https://non-cors.herokuapp.com/",wos_base:"https://www.worldofspectrum.org",wos_search:"/infoseekid.cgi%3Fid=",wos_index:"/games/",wos_top100:"/bestgames.html"},e=function(t){return new Promise((e,o)=>{const n=new XMLHttpRequest;n.open("GET",t),n.onload=function(){200==n.status?e(n.responseText):o(n.responseStatus)},n.onerror=function(){o(n.responseStatus)},n.send()})};t.getIndex=async function(o){"#"==o&&(o="1");var n="-"!=o?await e(t.cors_proxy+t.wos_base+t.wos_index+o.toLowerCase()+".html"):await e(t.cors_proxy+t.wos_base+t.wos_top100),r=$.parseHTML(n),a=[];return"-"!=o?$("pre",r).each((function(e,o){var n=0;for(var r of $("a",o))a.push({title:(++n).toString()+"."+$(r).text(),catalogue_url:t.cors_proxy+t.wos_base+$(r).attr("href").split("?").join("%3F")})})):$("table",r).each((function(e,o){if($("tr:contains('Score')",o).length){var n=0;for(var r of $("a",o))a.push({title:(++n).toString()+"."+$(r).text(),catalogue_url:t.cors_proxy+t.wos_base+$(r).attr("href").split("?").join("%3F")})}})),new Promise(t=>{t(a)})},t.getLinks=async function(o){var n=await e(o),r=$.parseHTML(n),a=[];return $("table",r).each((function(e,o){var n=$("tr:contains('Filename')",o);if(n.length){var r=$("td:contains('Filename')",n).index();for(var i of n.siblings()){var s=$("a",$("td:eq("+r+")",i)).attr("href");if(s){var p=s.split("."),c=p.pop().toUpperCase();"ZIP"==c&&(c=p.pop().toUpperCase()),"TZX"!=c&&"TAP"!=c&&"Z80"!=c&&"SNA"!=c||("TAP"==c?a.unshift(t.cors_proxy+t.wos_base+s):a.push(t.cors_proxy+t.wos_base+s))}}return!1}})),new Promise(t=>{t(a)})};var o=!1;return t.init=function(e,n,r,a){var i=$(e+" option").length;$(e).append($("<option></option>").text("TOP-100 - WorldOfSpectrum.org TOP-100")),$(e).append($("<option></option>").text("WoS All - WorldOfSpectrum.org full catalogue")),$(e).change((function(){switch(o=!1,$(e+" option:selected").index()-i){case 0:o=!0,$(n).empty(),$(n).append($("<option></option>").text("-")),$(n).trigger("change");break;case 1:o=!0,$(n).empty();for(var t="A".charCodeAt(0);t<="Z".charCodeAt(0);t++)$(n).append($("<option></option>").text(String.fromCharCode(t)));$(n).append($("<option></option>").text("#")),$(n).trigger("change")}})),$(n).change((function(){o&&($(r).empty(),t.getIndex($(n+" option:selected").html()).then((function(t){for(var e of t){var o=$("<option></option>");o.text(e.title),o.attr("href",e.catalogue_url),$(r).append(o)}$(r).trigger("change")})))})),$(r).change((function(){o&&($(a).empty(),t.getLinks($(r+" option:selected").attr("href")).then((function(t){for(var e=0;e<t.length;e++){var o=$("<option></option>");o.text((e+1).toString()+"."+t[e].slice(t[e].lastIndexOf("/")+1)),o.attr("href",t[e]),$(a).append(o)}})))})),$(e).trigger("change")},t}
